- path: ${NODE_SCRIPTS_PATH}/init/registerPoolPledge.sh
  permissions: "550"
  content: |
    #!/bin/bash

    messageSignTransaction() {
    cat <<EOF

    The transaction to register your pool needs to be signed. You'll need to do this on your cold machine.

    1.) Download the files from /home/${NODE_USER}/step-4.zip to your cold environment.

    Inside will be the following files:
    - tx-register-pool.raw
    - step-4.sh 
    - step-4.txt

    2.) Move all the files into the directory you are generating your keys with.
    3.) Execute 'step-2.sh', this will sign the transaction and generate one file.
    4.) Upload the generated file 'tx-register-pool.signed' into /home/${NODE_USER}/

    EOF
    }

    function doSubmitTransaction(){
      # Submit
      submitTransaction=$( cardano-cli transaction submit \
          --tx-file /home/${NODE_USER}/tx-register-pool.signed \
          ${NODE_NETWORK_FLAG} 2>&1 )

        if [[ $submitTransaction == 'Transaction successfully submitted.' ]]; then
          sed -i "s#\Register Pool Pledge|Running#Register Pool Pledge|Complete#g" /home/cardano/.nodeSetup
          echo "Transaction successfully submitted."
        else
          # Error with transaction
          echo "Error submitting transaction"
          return
          # TODO: Logging
        fi

        # Cleanup
        rm -rf /home/${NODE_USER}/tx-register-pool.signed
        rm -rf /home/${NODE_USER}/step-4.zip
    }


    if [ ! -f ${NODE_PRIVATE_PATH}/pool.cert ]; then
      message="Missing ${NODE_PRIVATE_PATH}/pool.cert"
      echo "$(tput setaf 1)$message$(tput sgr0)"
      return
    fi

    if [ ! -f ${NODE_PRIVATE_PATH}/deleg.cert ]; then
      message="Missing ${NODE_PRIVATE_PATH}/deleg.cert"
      echo "$(tput setaf 1)$message$(tput sgr0)"
      return
    fi

    # If signed transaction exists, try to submit it.
    if [ -f /home/${NODE_USER}/tx-register-pool.signed ]; then
      doSubmitTransaction
      return
    fi

    echo "Register Pool Pledge"

    stakePoolDeposit=$(cat ${NODE_HOME}/params.json | jq -r '.stakePoolDeposit')
    total_balance=$(. ${NODE_SCRIPTS_PATH}/getTxInfo.sh | jq -r '.balance')

    # If address balance is not enough for deposit...
    if [ ${total_balance} -lt ${stakePoolDeposit} ]; then
      echo "Not enough ADA. You need to send funds to your payment address. The deposit is ${stakePoolDeposit}, you have ${total_balance}"
      echo "Send at least ${stakePoolDeposit} to $(cat ${NODE_PRIVATE_PATH}/payment.addr)"
      return
    fi

    currentSlot=$(. ${NODE_SCRIPTS_PATH}/getTxInfo.sh | jq -r '.slotNumber')
    tx_in=$(. ${NODE_SCRIPTS_PATH}/getTxInfo.sh | jq -r '.txIn')
    txcnt=$(. ${NODE_SCRIPTS_PATH}/getTxInfo.sh | jq -r '.txCnt')

    # Build transaction
    cardano-cli transaction build-raw \
        ${tx_in} \
        --tx-out $(cat ${NODE_PRIVATE_PATH}/payment.addr)+$(( ${total_balance} - ${stakePoolDeposit}))  \
        --invalid-hereafter $(( ${currentSlot} + 10000)) \
        --fee 0 \
        --certificate-file ${NODE_PRIVATE_PATH}/pool.cert \
        --certificate-file ${NODE_PRIVATE_PATH}/deleg.cert \
        --out-file /home/${NODE_USER}/tx-register-pool.tmp

    fee=$(cardano-cli transaction calculate-min-fee \
        --tx-body-file /home/${NODE_USER}/tx-register-pool.tmp \
        --tx-in-count ${txcnt} \
        --tx-out-count 1 \
        ${NODE_NETWORK_FLAG} \
        --witness-count 3 \
        --byron-witness-count 0 \
        --protocol-params-file ${NODE_HOME}/params.json | awk '{ print $1 }')

    txOut=$((${total_balance}-${stakePoolDeposit}-${fee}))

    cardano-cli transaction build-raw \
        ${tx_in} \
        --tx-out $(cat ${NODE_PRIVATE_PATH}/payment.addr)+${txOut} \
        --invalid-hereafter $(( ${currentSlot} + 10000)) \
        --fee ${fee} \
        --certificate-file ${NODE_PRIVATE_PATH}/pool.cert \
        --certificate-file ${NODE_PRIVATE_PATH}/deleg.cert \
        --out-file /home/${NODE_USER}/tx-register-pool.raw


    # Generate file to download and run on cold machine
    if [ ! -f /home/${NODE_USER}/step-4.sh ]; then
      cat > /home/${NODE_USER}/step-4.sh << EOF 
        #!/bin/bash
        cardano-cli transaction sign --tx-body-file tx-register-pool.raw --signing-key-file payment.skey --signing-key-file node.skey --signing-key-file stake.skey ${NODE_NETWORK_FLAG} --out-file tx-register-pool.signed
        echo "Upload tx-register-pool.signed into /home/${NODE_USER}/"
    EOF
    chmod +x /home/${NODE_USER}/step-4.sh
    fi

    # Generate file for step 4 instructions
    if [ ! -f /home/${NODE_USER}/step-4.txt ]; then
      echo $(messageSignTransaction) > /home/${NODE_USER}/step-4.txt
    fi 

    # zip whats needed to transfer to cold machine
    zip -q -j \
      /home/${NODE_USER}/step-4.zip \
      /home/${NODE_USER}/tx-register-pool.raw \
      /home/${NODE_USER}/step-4.sh \
      /home/${NODE_USER}/step-4.txt

    # Cleanup
    rm -rf /home/${NODE_USER}/step-4.sh
    rm -rf /home/${NODE_USER}/step-4.txt
    rm -rf /home/${NODE_USER}/tx-register-pool.tmp
    rm -rf /home/${NODE_USER}/tx-register-pool.raw

    # Output instructions
    if [ ! -f /home/${NODE_USER}/tx-register-pool.signed ]; then

      messageSignTransaction

      # Start loop waiting for files
      RUN=true
      while $RUN
      do
      if [ -f /home/${NODE_USER}/tx-register-pool.signed ]; then
          RUN=false
          echo "Found tx-register-pool.signed! Continuing"
          sleep 2
      else
          sleep 2
      fi
      done
      # End loop waiting for files
    fi

    if [ -f /home/${NODE_USER}/tx-register-pool.signed ]; then
      # Submit transaction
      doSubmitTransaction
    fi